From b8203bca9fed335b58c46ad71a6204d8149faf61 Mon Sep 17 00:00:00 2001
From: zhongfly <11155705+zhongfly@users.noreply.github.com>
Date: Wed, 3 Jan 2024 21:57:38 +0800
Subject: [PATCH] ffmpeg: add patch to fix build

---
 ...-vf_drawtext-replace-is_newline-with.patch | 25 +++++++++++++++++++
 packages/ffmpeg.cmake                         |  1 +
 2 files changed, 26 insertions(+)
 create mode 100644 packages/ffmpeg-0001-avfilter-vf_drawtext-replace-is_newline-with.patch

diff --git a/packages/ffmpeg-0001-avfilter-vf_drawtext-replace-is_newline-with.patch b/packages/ffmpeg-0001-avfilter-vf_drawtext-replace-is_newline-with.patch
new file mode 100644
index 0000000..d2bf152
--- /dev/null
+++ b/packages/ffmpeg-0001-avfilter-vf_drawtext-replace-is_newline-with.patch
@@ -0,0 +1,25 @@
+From 5e15ceffd1e89fd3584b8e01d941cf71f05dc70e Mon Sep 17 00:00:00 2001
+From: zhongfly <11155705+zhongfly@users.noreply.github.com>
+Date: Wed, 3 Jan 2024 13:53:31 +0000
+Subject: [PATCH] avfilter/vf_drawtext: replace is_newline with ff_is_newline
+
+---
+ libavfilter/vf_drawtext.c | 2 +-
+ 1 file changed, 1 insertion(+), 1 deletion(-)
+
+diff --git a/libavfilter/vf_drawtext.c b/libavfilter/vf_drawtext.c
+index c1ea5b90b3..fe7e6ace27 100644
+--- a/libavfilter/vf_drawtext.c
++++ b/libavfilter/vf_drawtext.c
+@@ -684,7 +684,7 @@ static int shape_text(AVFilterContext *ctx)
+     fribidi_shape(flags, embedding_levels, len, ar_props, unicodestr);
+ 
+     for (line_end = 0, line_start = 0; line_end < len; line_end++) {
+-        if (is_newline(unicodestr[line_end]) || line_end == len - 1) {
++        if (ff_is_newline(unicodestr[line_end]) || line_end == len - 1) {
+             if (!fribidi_reorder_line(flags, bidi_types,
+                                       line_end - line_start + 1, line_start,
+                                       direction, embedding_levels, unicodestr,
+-- 
+2.43.0
+
diff --git a/packages/ffmpeg.cmake b/packages/ffmpeg.cmake
index b2a0d40..f806f69 100644
--- a/packages/ffmpeg.cmake
+++ b/packages/ffmpeg.cmake
@@ -46,6 +46,7 @@ ExternalProject_Add(ffmpeg
     GIT_REPOSITORY https://github.com/FFmpeg/FFmpeg.git
     SOURCE_DIR ${SOURCE_LOCATION}
     GIT_CLONE_FLAGS "--filter=tree:0"
+    PATCH_COMMAND ${EXEC} git am --3way ${CMAKE_CURRENT_SOURCE_DIR}/ffmpeg-*.patch
     UPDATE_COMMAND ""
     CONFIGURE_COMMAND ${EXEC} CONF=1 <SOURCE_DIR>/configure
         --cross-prefix=${TARGET_ARCH}-
-- 
2.42.0

